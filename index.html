<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InScope – Bilingual Exchange @ USYD</title>
  <meta name="description" content="InScope – A bilingual (EN/中文) student-led language exchange at USYD." />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --brand-700:#1E3AFF;
      --brand-600:#2F5BFF;
      --accent:#FFC83D;
      --ink:#0F172A;
      --card:#fff;
      --radius:16px;
      --shadow:0 8px 20px rgba(0,0,0,.1);
      --deep-blue:#0b3a7c;
      --muted:#475569;
    }
    body{margin:0;font-family:ui-sans-serif,system-ui;line-height:1.6;background:#f3f6fb}
    a{text-decoration:none}

    .nav{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto;padding:10px 20px}
    .brand-plate{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;box-shadow:var(--shadow)}
    .brand-plate img{height:40px}
    .brand-text{font-weight:800;color:#0b1b4a}
    .menu{display:flex;gap:18px;align-items:center}
    .menu a{font-weight:600;color:#0f172a}
    .cta{background:var(--brand-700);color:#fff;font-weight:700;padding:8px 14px;border-radius:999px}
    .hamburger{display:none}
    @media(max-width:850px){.menu{display:none}.hamburger{display:block}}

    .hero{position:relative;color:#fff;text-align:left;background: url("assets/BG1.png") center bottom / contain no-repeat;background-color:#fff;min-height:78vh;}
    .hero .wrap{position: relative;z-index: 1;max-width: 1100px;margin: 0 auto;padding: 200px 20px 100px;}
    .hero-logo-plate{display:inline-flex;align-items:center;gap:12px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:10px 14px;box-shadow:var(--shadow)}
    .hero-logo-plate img{height:80px}
    .hero-logo-plate .text{font-weight:900;font-size:22px;color:#0b1b4a}
    h1 {font-size: 48px;line-height: 1.2;margin: 20px 0;color: #fff;text-shadow: 0 4px 12px rgba(0,0,0,0.6);}
    .actions{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:12px 18px;border-radius:999px;font-weight:700;border:2px solid transparent;cursor:pointer}
    .btn.primary{background:#fff;color:#1E3AFF;border-color:#dbeafe}
    .btn.outline{background:rgba(30,58,138,0.85);color:#fff;border:2px solid #1E3AFF}
    .btn.outline:hover { background:#1E3AFF; border-color:#1E3AFF; }

    section{padding:60px 20px}
    .container{max-width:1100px;margin:0 auto}
    .surface{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);box-shadow:var(--shadow);padding:28px}
    .section-title{font-size:26px;display:flex;align-items:center;gap:8px;margin:0 0 18px}
    .badge-key{display:inline-flex;width:28px;height:28px;align-items:center;justify-content:center;border:1px solid #e5e7eb;border-radius:6px;background:#fff;box-shadow:var(--shadow)}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .meta{color:#64748b;font-size:14px}

    .section-wrap{display:grid;grid-template-columns:320px 1fr;gap:22px;align-items:start;}
    .section-img{background:#0c3b82;border-radius:16px;overflow:hidden;border:1px solid #e5e7eb;box-shadow:var(--shadow);}
    .section-img img{display:block;width:100%;height:auto}

    footer{background:var(--deep-blue);border-top:1px solid rgba(255,255,255,.15);padding:40px 20px;color:#eaf2ff}
    .footer-grid{display:grid;gap:18px;grid-template-columns:2fr 1fr 1fr 1fr;max-width:1100px;margin:0 auto}
    .footer-grid a{color:#fff}
    .brand-plate.footer{box-shadow:none;border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.92)}
    .copyright{text-align:center;margin-top:20px;font-size:13px;color:#e4edff}
    @media(max-width:900px){.footer-grid{grid-template-columns:1fr 1fr}.section-wrap{grid-template-columns:1fr}}

    /* General modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(520px,90vw);background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.18);padding:22px}
    .modal h3{margin:0 0 10px;font-size:20px}
    .modal .row{display:flex;gap:10px;margin:10px 0}
    .modal input, .modal textarea, .modal select{flex:1;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
    .modal button{padding:10px 14px;border-radius:10px;border:1px solid #1E3AFF;background:#1E3AFF;color:#fff;font-weight:700;cursor:pointer}
    .modal .ghost{background:#fff;color:#1E3AFF;border-color:#1E3AFF}
    .modal .msg{font-size:13px;color:#475569;min-height:20px;margin-top:4px}

    /* Intake only */
    .modal.intake .desc{color:#475569;font-size:14px;margin-bottom:6px}

    /* Feedback stars */
    .stars{display:inline-flex;align-items:center;gap:2px;font-size:0}
    .star{font-size:26px;cursor:pointer;user-select:none;line-height:1}
    .star.half::after{content:'\2605'; display:inline-block; width:0.5em; overflow:hidden}
    .hint{font-size:13px;color:#64748b;margin-left:8px}
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <div class="nav-inner">
      <a class="brand-plate" href="#home"><img src="assets/inscope_logo.png" alt=""><span class="brand-text">InScope</span></a>
      <div class="menu">
        <a href="#sessions">Sessions 活动</a>
        <a href="#how">How It Works 使用方式</a>
        <a href="#resources">Resources 资源</a>
        <a href="#about">About 关于</a>
        <a class="cta" href="#sessions">Join 加入</a>
      </div>
      <button class="hamburger">☰</button>
    </div>
  </nav>

  <!-- HERO -->
  <header id="home" class="hero">
    <div class="wrap">
      <div class="hero-logo-plate"><img src="assets/inscope_logo.png" alt=""><span class="text">InScope</span></div>
      <h1>Practice languages in English & Chinese · 中英双语交流</h1>
      <div class="actions">
        <a class="btn primary" href="#sessions">Join a Session 参加活动</a>
      </div>
    </div>
  </header>

  <!-- HOW -->
  <section id="how">
    <div class="container">
      <div class="section-wrap">
        <aside class="section-img">
          <img src="assets/BG2.png" alt="How it works illustration">
        </aside>
        <div class="surface">
          <h2 class="section-title"><span class="badge-key">🎹</span> How It Works · 使用方式</h2>
          <div class="grid">
            <div class="card">Step 1 · Pick a table 选择语言桌</div>
            <div class="card">Step 2 · Share & practice 分享练习</div>
            <div class="card">Step 3 · Reflect & connect 交流拓展</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SESSIONS -->
  <section id="sessions">
    <div class="container">
      <div class="section-wrap">
        <aside class="section-img">
          <img src="assets/BG3.png" alt="Sessions illustration">
        </aside>
        <div class="surface">
          <h2 class="section-title"><span class="badge-key">🎹</span> Sessions 活动</h2>
          <div class="grid" id="courses-grid">
            <div class="card">Loading courses… 加载中…</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- RESOURCES -->
  <section id="resources">
    <div class="container">
      <div class="section-wrap">
        <aside class="section-img">
          <img src="assets/BG4.png" alt="Resources illustration">
        </aside>
        <div class="surface">
          <h2 class="section-title"><span class="badge-key">🎹</span> Resources 资源</h2>
          <div class="grid">
            <div class="card">Resource 1</div>
            <div class="card">Resource 2</div>
            <div class="card">Resource 3</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about">
    <div class="container surface">
      <h2 class="section-title"><span class="badge-key">🎹</span> About 关于</h2>
      <div class="card"><p>InScope is a not-for-profit, student-run bilingual exchange. · 学生自发、非营利的双语交流项目。</p></div>
    </div>
  </section>

  <!-- FEEDBACK -->
  <section id="feedback">
    <div class="container surface">
      <h2 class="section-title"><span class="badge-key">📝</span> Feedback 意见反馈</h2>
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div id="star-wrap" class="stars" aria-label="rating"></div>
          <span id="star-hint" class="hint">请选择 1–5 星（可半星）</span>
        </div>
        <div class="row" style="margin-top:12px">
          <textarea id="fb-text" rows="3" placeholder="可选留言 · Optional message"></textarea>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="btn-send-feedback">Submit 提交</button>
        </div>
        <div class="msg" id="fb-msg"></div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="footer-grid">
      <div>
        <div class="brand-plate footer"><img src="assets/inscope_logo.png" alt=""><span class="brand-text">InScope</span></div>
        <p>A student-led bilingual exchange at USYD · 悉尼大学学生双语交流。</p>
      </div>
      <div><strong>Explore</strong><div><a href="#sessions">Sessions</a></div><div><a href="#resources">Resources</a></div></div>
      <div><strong>Project</strong><div><a href="#how">How it works</a></div><div><a href="#about">About</a></div></div>
      <div><strong>Get in touch</strong><div><a href="https://www.instagram.com/inscope_vibes?igsh=MXo2cnk4ZWl1ZXY=">InScope Team</a></div></div>
    </div>
    <div class="copyright">© <span id="y"></span> InScope. Made with ♥ in Sydney. <span id="api-tip" style="opacity:.7"></span></div>
  </footer>

  <!-- ===== Intake Modal (username + email) ===== -->
  <div id="modal-intake" class="modal-overlay" aria-hidden="true">
    <div class="modal intake">
      <h3>Welcome 欢迎 · InScope</h3>
      <div class="desc">请输入用户名与邮箱后即可使用网站。任何用户名/邮箱均可。<br/>Enter your username & email to continue (no strict rules).</div>
      <div class="row"><input id="intake-username" placeholder="Username 用户名" /></div>
      <div class="row"><input id="intake-email" type="email" placeholder="Email 邮箱" /></div>
      <div class="row" style="justify-content:flex-end">
        <button id="btn-intake-continue">Continue 继续</button>
      </div>
      <div class="msg" id="intake-msg"></div>
    </div>
  </div>
  <!-- ===== /Intake Modal ===== -->

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>

  <!-- ===== API base chooser (default + ?api= + localStorage) ===== -->
  <script>
  (() => {
    const DEFAULT_API = 'https://inscope-api.onrender.com';
    function getApiBase() {
      try {
        const u = new URL(location.href);
        const q = u.searchParams.get('api');
        if (q) {
          localStorage.setItem('inscope_api_base', q);
          return q;
        }
        return localStorage.getItem('inscope_api_base') || DEFAULT_API;
      } catch { return DEFAULT_API; }
    }
    window.API_BASE = getApiBase();
    console.log('[InScope] API_BASE =', window.API_BASE);
    const tip = document.getElementById('api-tip');
    if (tip) tip.textContent = `· API: ${window.API_BASE}`;
  })();
  </script>

  <!-- ===== Main Script ===== -->
  <script>
  (() => {
    const API_BASE = window.API_BASE;
    const JSON_HEADERS = {'Content-Type':'application/json'};

    const $ = (sel, root=document) => root.querySelector(sel);
    const show = el => { el.style.display='flex'; el.setAttribute('aria-hidden','false'); };
    const hide = el => { el.style.display='none'; el.setAttribute('aria-hidden','true'); };

    function getUser() {
      try { return JSON.parse(localStorage.getItem('inscope_user') || 'null'); } catch { return null; }
    }
    function setUser(u) { localStorage.setItem('inscope_user', JSON.stringify(u || null)); }

    async function safeGet(path) {
      try {
        const res = await fetch(`${API_BASE}${path}`);
        const json = await res.json().catch(()=>({}));
        return { ok: res.ok, status: res.status, json };
      } catch (e) { return { ok:false, status:0, json:{ message:'offline' } }; }
    }
    async function safePost(path, body) {
      try {
        const res = await fetch(`${API_BASE}${path}`, {
          method:'POST', headers: JSON_HEADERS, body: JSON.stringify(body || {})
        });
        let data = null;
        try { data = await res.json(); } catch {}
        return { ok: res.ok, status: res.status, json: data || {} };
      } catch (e) { return { ok:false, status:0, json:{ message:'offline' } }; }
    }

    // ===== Intake flow =====
    const intakeModal = $('#modal-intake');
    const intakeBtn = $('#btn-intake-continue');
    const intakeMsg = $('#intake-msg');

    function requireIntake() {
      const u = getUser();
      if (!u || !u.username || !u.email) show(intakeModal); else hide(intakeModal);
    }

    intakeBtn.addEventListener('click', async () => {
      const username = $('#intake-username').value.trim();
      const email = $('#intake-email').value.trim();
      if (!username || !email) { intakeMsg.textContent = '请填写用户名与邮箱 / Please enter username and email'; return; }
      const user = { username, email, ts: Date.now() };
      setUser(user);
      // 记录到后端（后端就绪时会入库）
      safePost('/api/v1/intake', { username, email });
      hide(intakeModal);
    });

    // ===== Courses (静态两场) =====
    const courses = [
      { id:'c1', title:'Bilingual Exchange · 双语交流（第1期）', date:'2025-10-07', time:'TBD', location:'TBD', max:30 },
      { id:'c2', title:'Bilingual Exchange · 双语交流（第2期）', date:'2025-10-14', time:'TBD', location:'TBD', max:30 },
    ];

    function renderCourses() {
      const grid = $('#courses-grid');
      grid.innerHTML = '';
      courses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h4>${course.title}</h4>
          <div class="meta">Date 日期: ${course.date}</div>
          <div class="meta">Time 时间: ${course.time}</div>
          <div class="meta">Location 地点: ${course.location}</div>
          <div class="meta">Maxmember 人数上限: ${course.max}</div>
          <button class="btn primary" data-id="${course.id}">Enroll 报名</button>
        `;
        grid.appendChild(card);
      });

      grid.querySelectorAll('button[data-id]').forEach(btn => {
        btn.onclick = async () => {
          const user = getUser();
          if (!user) { show(intakeModal); return; }
          const id = btn.getAttribute('data-id');
          btn.disabled = true;
          btn.textContent = '已报名';
          const res = await safePost(`/api/v1/courses/${id}/enroll`, { username:user.username, email:user.email });
          if (!res.ok) console.warn('Enroll not saved to backend:', res);
        };
      });
    }

    // ===== Feedback (评分 + 留言) =====
    const starWrap = $('#star-wrap');
    const starHint = $('#star-hint');
    const fbBtn = $('#btn-send-feedback');
    const fbMsg = $('#fb-msg');
    const fbText = $('#fb-text');

    let rating = 0;

    function buildStars() {
      starWrap.innerHTML = '';
      for (let i=1; i<=5; i++) {
        const span = document.createElement('span');
        span.className = 'star';
        span.textContent = '★';
        span.dataset.index = String(i);
        starWrap.appendChild(span);
      }

      function paint(r) {
        const full = Math.floor(r);
        const half = (r - full) >= 0.5 ? 1 : 0;
        [...starWrap.children].forEach((s, idx) => {
          const i = idx + 1;
          s.style.color = (i <= full) ? '#FFC83D'
                         : (i === full + 1 && half) ? '#FFC83D'
                         : '#e5e7eb';
          s.classList.toggle('half', i === full + 1 && half);
        });
        starHint.textContent = r ? `评分：${r.toFixed(1)} 星` : '请选择 1–5 星（可半星）';
      }

      function clickHandler(e) {
        if (!(e.target instanceof HTMLElement) || !e.target.classList.contains('star')) return;
        const rect = e.target.getBoundingClientRect();
        const half = (e.clientX - rect.left) < rect.width / 2 ? 0.5 : 1.0;
        const idx = Number(e.target.dataset.index);
        let val = idx - 1 + half;
        if (val < 1) val = 1;
        rating = Math.min(5, Math.max(1, val));
        paint(rating);
      }

      starWrap.addEventListener('mousemove', (e) => {
        if (!(e.target instanceof HTMLElement) || !e.target.classList.contains('star')) return;
        const rect = e.target.getBoundingClientRect();
        const half = (e.clientX - rect.left) < rect.width / 2 ? 0.5 : 1.0;
        const idx = Number(e.target.dataset.index);
        let hoverVal = Math.min(5, Math.max(1, idx - 1 + half));
        const full = Math.floor(hoverVal);
        const halfFlag = (hoverVal - full) >= 0.5 ? 1 : 0;
        [...starWrap.children].forEach((s, i) => {
          const j = i + 1;
          s.style.color = (j <= full) ? '#FFC83D'
                         : (j === full + 1 && halfFlag) ? '#FFC83D' : '#e5e7eb';
          s.classList.toggle('half', j === full + 1 && halfFlag);
        });
        starHint.textContent = `评分：${hoverVal.toFixed(1)} 星`;
      });

      starWrap.addEventListener('mouseleave', () => paint(rating));
      starWrap.addEventListener('click', clickHandler);

      paint(rating);
    }

    fbBtn.addEventListener('click', async () => {
      const user = getUser();
      if (!user) { show(intakeModal); return; }
      if (!rating) { fbMsg.textContent = '请先评分（支持半星）'; return; }
      fbMsg.textContent = '提交中…';
      const payload = {
        username: user.username,
        email: user.email,
        rating,
        message: fbText.value.trim() || null,
        ts: Date.now()
      };
      const res = await safePost('/api/v1/feedback', payload);
      if (res.ok) { fbMsg.textContent = '感谢反馈！Thanks for your feedback!'; fbText.value = ''; }
      else { fbMsg.textContent = '已在前端记录，后端暂未连接。稍后可重试。'; }
    });

    // ===== Init =====
    async function init() {
      requireIntake();
      renderCourses();
      buildStars();
      // 触发一次健康检查以唤醒后端
      const h = await safeGet('/api/v1/health');
      console.log('[InScope] health:', h.status, h.json);
    }
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>